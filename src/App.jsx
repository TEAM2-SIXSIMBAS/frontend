import { useEffect, useRef, useState } from "react";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import TopBanner from "./components/TopBanner";
import PartnershipCard from "./components/PartnershipCard";
import OceanWorld from "./pages/InfoDetail/OceanWorld";
import InfoMap from "./pages/InfoMap/c";
import ShopInfo from "./pages/ShopInfo/f";
import "./App.css";

/* =========================================================
   ÌååÎùºÎØ∏ÌÑ∞ Í∑úÏïΩ (ÌîÑÎ°†Ìä∏ ‚Üí Î∞±ÏóîÎìú)
   - "Ï†ÑÏ≤¥"Îäî Îπà Î¨∏ÏûêÏó¥("") Ï†ÑÏÜ° (=ÌïÑÌÑ∞ ÎØ∏Ï†ÅÏö©)
   - ÏµúÏ¢Ö ÏöîÏ≤≠:
     /partnership-info?organization=a,b,c&category=x,y&type=m,n&sort={Ï†ïÎ†¨}&page={ÌéòÏù¥ÏßÄ}
   ========================================================= */

// fallbackÏö© ÏûÑÏãú Ïç∏ÎÑ§Ïùº (DTOÏóê imageUrl ÏóÜÏùÑ ÎïåÎßå ÏÇ¨Ïö©)
const random_img = (id) => `https://picsum.photos/400/300?random=${id}`;

// ‚ñº ÎìúÎ°≠Îã§Ïö¥ ÏòµÏÖò
const ORGANIZATIONS = ["Ï†ÑÏ≤¥", "Ï¥ùÌïô", "Ï¥ùÎèô", "Îã®Í≥ºÎåÄ", "ÌïôÍ≥º", "Í∏∞ÌÉÄ"];
const CATEGORIES    = ["Ï†ÑÏ≤¥", "ÏùåÏãù", "Ïπ¥Ìéò", "ÏÉùÌôú", "Î¨∏Ìôî"];
const TYPES         = ["Ï†ÑÏ≤¥", "Ìï†Ïù∏", "ÏÑúÎπÑÏä§"];

const SORTS = [
  { key: "idAsc", label: "Îì±Î°ùÏàú" },
  { key: "popular", label: "Ï°∞ÌöåÏàò ÎÜíÏùÄ Ïàú" },
  { key: "discountDesc", label: "Ìï†Ïù∏Ïú® ÎÜíÏùÄ Ïàú" },
  { key: "discountAsc", label: "Ìï†Ïù∏Ïú® ÎÇÆÏùÄ Ïàú" },
  { key: "deadlineAsc", label: "Í∏∞Ìïú Îπ†Î•∏ Ïàú" },
  { key: "deadlineDesc", label: "Í∏∞Ìïú ÎäêÎ¶∞ Ïàú" },
];

/* =========================================================
   DTO -> Ïπ¥Îìú props Îß§Ìïë
   - ÏÑúÎ≤Ñ DTO: { id?, content, storeName, organization, category, type, imageUrl? }
   ========================================================= */
const toCard = (dto, idx = 0, offset = 0) => {
  const id = dto.id ?? offset + idx + 1;
  return {
    id,
    title: dto.content ?? "",
    merchant: dto.storeName ?? "",
    tags: [dto.organization, dto.type].filter(Boolean),
    category: dto.category ?? "",
    img: dto.partnershipImageUrl || random_img(id),
    hot: false,
  };
};

// "Ï†ÑÏ≤¥" ‚Üí Îπà Î¨∏ÏûêÏó¥, Î∞∞Ïó¥ ÏÑ†ÌÉùÍ∞íÏùÄ ÏΩ§ÎßàÎ°ú Ìï©ÏπòÍ∏∞
const encodeMultiParam = (arr) => {
  if (!arr || arr.length === 0 || arr.includes("Ï†ÑÏ≤¥")) return "";
  return arr.join(",");
};

const isAllSelected = (arr) => !arr || arr.length === 0 || arr.includes("Ï†ÑÏ≤¥");

/* =========================================================
   Ïª§Ïä§ÌÖÄ Î©ÄÌã∞ÏÖÄÎ†âÌä∏ (Ï†ïÎ†¨ ÎìúÎ°≠Îã§Ïö¥Ï≤òÎüº Î≥¥Ïù¥Îäî UI)
   - props:
     options: string[]
     value: string[]          // ["Ï†ÑÏ≤¥"] ÎòêÎäî ["ÏùåÏãù","Ïπ¥Ìéò"] Îì±
     onChange(next: string[]) // Ï†úÏñ¥ Ïª¥Ìè¨ÎÑåÌä∏
     label: string            // Î≤ÑÌäº placeholder (Ïòà: "Í∏∞Í¥Ä")
   - ÌäπÏßï:
     ‚Ä¢ "Ï†ÑÏ≤¥" ÏÑ†ÌÉù Ïãú ÎÇòÎ®∏ÏßÄ Ìï¥Ï†ú
     ‚Ä¢ Î™®Îëê Ìï¥Ï†úÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú ["Ï†ÑÏ≤¥"]
     ‚Ä¢ Î≤ÑÌäº ÎùºÎ≤®: "Ï†ÑÏ≤¥" ÎòêÎäî "NÍ∞ú ÏÑ†ÌÉù"
     ‚Ä¢ ÌÇ§Î≥¥Îìú: Enter/Space Ïó¥Í∏∞/Ï≤¥ÌÅ¨, Esc Îã´Í∏∞, Tab Ìè¨Ïª§Ïä§ Ïù¥Îèô
   ========================================================= */
function MultiSelect({ options, value, onChange, label, ariaLabel }) {
  const [open, setOpen] = useState(false);
  const btnRef = useRef(null);
  const menuRef = useRef(null);

  const displayText = isAllSelected(value)
    ? "Ï†ÑÏ≤¥"
    : `${value.length}Í∞ú ÏÑ†ÌÉù`;

  const toggleOpen = () => setOpen((v) => !v);
  const close = () => setOpen(false);

  // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Îã´Í∏∞
  useEffect(() => {
    if (!open) return;
    const onDocClick = (e) => {
      if (!menuRef.current && !btnRef.current) return;
      if (
        menuRef.current?.contains(e.target) ||
        btnRef.current?.contains(e.target)
      ) return;
      setOpen(false);
    };
    const onEsc = (e) => {
      if (e.key === "Escape") setOpen(false);
    };
    document.addEventListener("mousedown", onDocClick);
    document.addEventListener("keydown", onEsc);
    return () => {
      document.removeEventListener("mousedown", onDocClick);
      document.removeEventListener("keydown", onEsc);
    };
  }, [open]);

  const handleToggle = (opt) => {
    if (opt === "Ï†ÑÏ≤¥") {
      onChange(["Ï†ÑÏ≤¥"]);
      return;
    }
    let next = Array.isArray(value) ? [...value] : [];
    // Ï†ÑÏ≤¥Í∞Ä Ìè¨Ìï®Îèº ÏûàÏúºÎ©¥ Ï†úÍ±∞
    next = next.filter((v) => v !== "Ï†ÑÏ≤¥");
    if (next.includes(opt)) {
      next = next.filter((v) => v !== opt);
    } else {
      next.push(opt);
    }
    if (next.length === 0) next = ["Ï†ÑÏ≤¥"];
    onChange(next);
  };

  return (
    <div className="ms">
      <button
        ref={btnRef}
        type="button"
        className="ms__button"
        aria-haspopup="listbox"
        aria-expanded={open}
        aria-label={ariaLabel || label}
        onClick={toggleOpen}
      >
        <span className="ms__button-label">{label}</span>
        <span className="ms__button-value">{displayText}</span>
        <span className="ms__chevron" aria-hidden>‚ñæ</span>
      </button>

      {open && (
        <div
          ref={menuRef}
          className="ms__menu"
          role="listbox"
          aria-multiselectable="true"
        >
          {options.map((opt) => {
            const checked =
              opt === "Ï†ÑÏ≤¥"
                ? isAllSelected(value)
                : Array.isArray(value) && value.includes(opt);
            return (
              <label key={opt} className="ms__option" role="option" aria-selected={checked}>
                <input
                  type="checkbox"
                  checked={checked}
                  onChange={() => handleToggle(opt)}
                />
                <span>{opt}</span>
              </label>
            );
          })}
        </div>
      )}
    </div>
  );
}

function SingleSelect({ options, value, onChange, label, ariaLabel }) {
  const [open, setOpen] = useState(false);
  const btnRef = useRef(null);
  const menuRef = useRef(null);

  const current = options.find((o) => o.key === value);
  const displayText = current ? current.label : "";

  const toggleOpen = () => setOpen((v) => !v);

  useEffect(() => {
    if (!open) return;
    const onDocClick = (e) => {
      if (menuRef.current?.contains(e.target)) return;
      if (btnRef.current?.contains(e.target)) return;
      setOpen(false);
    };
    const onEsc = (e) => { if (e.key === "Escape") setOpen(false); };
    document.addEventListener("mousedown", onDocClick);
    document.addEventListener("keydown", onEsc);
    return () => {
      document.removeEventListener("mousedown", onDocClick);
      document.removeEventListener("keydown", onEsc);
    };
  }, [open]);

  const pick = (k) => { onChange(k); setOpen(false); };

  return (
    <div className="ms">
      <button
        ref={btnRef}
        type="button"
        className="ms__button"
        aria-haspopup="listbox"
        aria-expanded={open}
        aria-label={ariaLabel || label}
        onClick={toggleOpen}
      >
        <span className="ms__button-label">{label}</span>
        <span className="ms__button-value">{displayText}</span>
        <span className="ms__chevron" aria-hidden>‚ñæ</span>
      </button>

      {open && (
        <div
          ref={menuRef}
          className="ms__menu"
          role="listbox"
          aria-multiselectable="false"
        >
          {options.map((opt) => {
            const checked = opt.key === value;
            return (
              <label key={opt.key} className="ms__option" role="option" aria-selected={checked}>
                <input
                  type="radio"
                  name={`single-${label}`}
                  checked={checked}
                  onChange={() => pick(opt.key)}
                />
                <span>{opt.label}</span>
              </label>
            );
          })}
        </div>
      )}
    </div>
  );
}

function HomePage() {
  const [activeTab, setActiveTab] = useState("Ï†úÌú¥ Ï†ïÎ≥¥");

  // üîπ Î©ÄÌã∞ÏÖÄÎ†âÌä∏ ÏÉÅÌÉú
  const [organizations, setOrganizations] = useState(["Ï†ÑÏ≤¥"]); // ORGANIZATION(Í∏∞Í¥Ä)
  const [categories, setCategories] = useState(["Ï†ÑÏ≤¥"]); // CATEGORY(ÏóÖÏ¢Ö)
  const [types, setTypes] = useState(["Ï†ÑÏ≤¥"]); // TYPE(ÌòúÌÉù)

  const [sort, setSort] = useState("idAsc");
  const [page, setPage] = useState(1); // 1 Í∏∞Î∞ò
  const [pageCount, setPageCount] = useState(1);

  const [top3, setTop3] = useState([]);
  const [allList, setAll] = useState([]);

  const API_BASE = import.meta.env.VITE_API_BASE ?? "";
  const USE_MOCK = false;

  // ÏÑúÎ≤Ñ Ìò∏Ï∂ú
  useEffect(() => {
    if (USE_MOCK) return;

    const controller = new AbortController();
    const q = new URLSearchParams();
    q.set("organization", encodeMultiParam(organizations));
    q.set("category",     encodeMultiParam(categories));
    q.set("type",         encodeMultiParam(types));
    q.set("sort",         sort);
    q.set("page",         String(page));

    const url = `${API_BASE}/partnership-info?${q.toString()}`;

    const allAll =
      isAllSelected(organizations) &&
      isAllSelected(categories) &&
      isAllSelected(types);
    const time = new Date().toLocaleTimeString();
    if (allAll) {
      console.groupCollapsed(`[ALL][${time}] ${url}`);
    }

    fetch(url, {
      headers: { Accept: "application/json" },
      signal: controller.signal,
    })
      .then(async (res) => {
        const raw = await res.clone().text().catch(() => "");

        if (!res.ok) {
          if (allAll) console.groupEnd();
          throw new Error(`HTTP ${res.status}`);
        }

        let json = {};
        try {
          json = raw ? JSON.parse(raw) : {};
        } catch (e) {
          if (allAll) {
            console.error("[ALL] JSON parse error:", e);
            console.log("[ALL] raw(Î¨∏ÏûêÏó¥) =", raw.slice(0, 300));
            console.groupEnd();
          }
          throw e;
        }

        // ÏÑúÎ≤Ñ Ïä§ÌÇ§Îßà: { top3: [], sort: [], pageAmount: number }
        const listRaw    = Array.isArray(json.sort) ? json.sort : [];
        const pageAmount = Math.max(1, Number(json.pageAmount) || 1);

        if (allAll) {
          console.log("[ALL] keys =", Object.keys(json));
          console.log("[ALL] lengths =", {
            top3: Array.isArray(json.top3) ? json.top3.length : "n/a",
            list: listRaw.length,
          });
          console.log("[ALL] pageAmount =", pageAmount);
          const pick = (x) => ({
            content: x?.content,
            storeName: x?.storeName,
            organization: x?.organization,
            category: x?.category,
            type: x?.type,
            partnershipImageUrl: x?.partnershipImageUrl,
          });
          console.table(listRaw.slice(0, 5).map(pick));
          console.groupEnd();
        }

        const mappedTop3 = Array.isArray(json.top3)
          ? json.top3.map((d, i) => ({ ...toCard(d, i, 1000), hot: true }))
          : [];
        const mappedList = listRaw.map((d, i) => toCard(d, i, 0));

        setTop3(mappedTop3);
        setAll(mappedList);
        setPageCount(pageAmount);

        if (page > pageAmount) setPage(1);
      })
      .catch((e) => {
        if (e.name !== "AbortError") console.error("[API] fetch failed:", e);
        setTop3([]);
        setAll([]);
        setPageCount(1);
      });

    return () => controller.abort();
  }, [organizations, categories, types, sort, page, API_BASE, USE_MOCK]);

  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω: pageÎßå Î≥ÄÍ≤Ω (ÌïÑÌÑ∞/Ï†ïÎ†¨ÏùÄ Ïú†ÏßÄ)
  const changePage = (p) => {
    if (p < 1 || p > pageCount) return;
    setPage(p);
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  // ÌïÑÌÑ∞ Î≥ÄÍ≤Ω Ïãú page=1
  const resetToFirstPage = () => setPage(1);

  return (
    <div className="app">
      <div className="app__container">
        <TopBanner activeTab={activeTab} onChange={setActiveTab} />

        <main>
          {/* Top3: 3Í∞ú Í≥†Ï†ï */}
          <section className="section section--hot">
            <div className="section__head">
              <h2 className="section__title">ÏßÄÍ∏à Ìï´Ìïú ÌòúÌÉù Top 3</h2>
            </div>
            <div className="grid grid--3">
              {top3.map((item, i) => (
                <PartnershipCard
                  key={`top-${item.id}-${i}`}
                  item={item}
                  to={`/info/${item.id}`}
                />
              ))}
            </div>
          </section>

          {/* ÎÇòÎ®∏ÏßÄ Î™©Î°ù */}
          <section className="section section--list">
            <div className="section__head section__head--controls">
              <h3 className="section__title">Ï†úÌú¥ Ï†ïÎ≥¥</h3>

              <div className="controls controls--flex">
                {/* üîπ Í∏∞Í¥Ä */}
                <MultiSelect
                  options={ORGANIZATIONS}
                  value={organizations}
                  onChange={(next) => { setOrganizations(next); resetToFirstPage(); }}
                  label="Í∏∞Í¥Ä"
                  ariaLabel="Í∏∞Í¥Ä ÌïÑÌÑ∞"
                />

                {/* üîπ ÏóÖÏ¢Ö */}
                <MultiSelect
                  options={CATEGORIES}
                  value={categories}
                  onChange={(next) => { setCategories(next); resetToFirstPage(); }}
                  label="ÏóÖÏ¢Ö"
                  ariaLabel="ÏóÖÏ¢Ö ÌïÑÌÑ∞"
                />

                {/* üîπ ÌòúÌÉù */}
                <MultiSelect
                  options={TYPES}
                  value={types}
                  onChange={(next) => { setTypes(next); resetToFirstPage(); }}
                  label="ÌòúÌÉù"
                  ariaLabel="ÌòúÌÉù ÌïÑÌÑ∞"
                />

                {/* Ï†ïÎ†¨ (Îã®Ïùº ÎÑ§Ïù¥Ìã∞Î∏å ÏÖÄÎ†âÌä∏ Ïú†ÏßÄ) */}
                <SingleSelect
                    options={SORTS}
                    value={sort}
                    onChange={(next) => { setSort(next); setPage(1); }}
                    label="Ï†ïÎ†¨"
                    ariaLabel="Ï†ïÎ†¨ Í∏∞Ï§Ä"
                />
              </div>
            </div>

            <div className="grid grid--3">
              {allList.map((item, i) => (
                <PartnershipCard
                  key={`list-${item.id}-${i}`}
                  item={item}
                  to={`/info/${item.id}`}
                />
              ))}
            </div>

            <nav className="pagination" aria-label="ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò">
              <button
                className="pagination__btn"
                onClick={() => changePage(page - 1)}
                disabled={page === 1}
              >
                Ïù¥Ï†Ñ
              </button>
              {Array.from({ length: pageCount }, (_, i) => i + 1).map((p) => (
                <button
                  key={p}
                  className={`pagination__num ${p === page ? "is-active" : ""}`}
                  onClick={() => changePage(p)}
                >
                  {p}
                </button>
              ))}
              <button
                className="pagination__btn"
                onClick={() => changePage(page + 1)}
                disabled={page === pageCount}
              >
                Îã§Ïùå
              </button>
            </nav>
          </section>
        </main>
      </div>
    </div>
  );
}

export default function App() {
    return (
        <BrowserRouter>
            <Routes>
                <Route path="/" element={<HomePage />} />
                <Route path="/info/:partnershipId" element={<OceanWorld />} />
                <Route path="/map" element={<InfoMap />} />
                <Route path="/partners" element={<ShopInfo />} />
            </Routes>
        </BrowserRouter>
    );
}